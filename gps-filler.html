<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GPS Filler Simulator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
    label { display: block; margin-top: 10px; }
    select, input, button { padding: 8px; margin-top: 5px; width: 100%; max-width: 400px; }
    button { background: #1976d2; color: #fff; border: none; cursor: pointer; }
    button.stop { background: #d32f2f; }
    #log { margin-top: 20px; padding: 10px; background: #fff; border: 1px solid #ccc; height: 200px; overflow: auto; }
  </style>
</head>
<body>
  <h1>GPS Filler Simulator</h1>

  <label for="users">Selecteer gebruikers (meerdere):</label>
  <select id="users" multiple></select>

  <label for="route">Selecteer route:</label>
  <select id="route"></select>

  <label for="delay">Delay (sec per update):</label>
  <input type="number" id="delay" value="5" min="1" max="60">
<div>
  <label for="mode">Mode:</label>
  <select id="mode">
    <option value="normal">Normaal (zoals nu)</option>
    <option value="real">Real-life (wandelen)</option>
  </select>
</div>
  <button id="startBtn">Start</button>
  <button id="stopBtn" class="stop">Stop</button>

  <div id="log"></div>

  <h2>Diagnose</h2>
<div id="diag" style="font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; background:#fff;border:1px solid #ccc;padding:10px;"></div>


  <script>
    const logDiv = document.getElementById('log');

    function log(msg) {
      const now = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${now}] ${msg}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function loadUsers() {
      const res = await fetch('gps-filler.php?action=getUsers');
      const users = await res.json();
      const select = document.getElementById('users');
      select.innerHTML = '';
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.device_id;
        opt.textContent = `${u.own_email} (${u.device_id})`;
        select.appendChild(opt);
      });
    }


  // ... boven blijft gelijk

  async function loadRoutes() {
    const res = await fetch('gps-filler.php?action=getRoutes');
    const routes = await res.json();
    const select = document.getElementById('route');
    select.innerHTML = '';
    routes.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r.value;     // routenaam als value
      opt.textContent = r.label;
      select.appendChild(opt);
    });
  }


async function startSim() {
  const users = Array.from(document.getElementById('users').selectedOptions).map(o => o.value);
  const route = document.getElementById('route').value;
  const delay = document.getElementById('delay').value;
const mode  = document.getElementById("mode").value; // ✅ toegevoegd

  if (!users.length || !route) {
    alert('Selecteer minstens één gebruiker en een route.');
    return;
  }

  const payload = { users, route, delay, mode };
console.log("[DEBUG] POST payload →", JSON.stringify(payload));

  const res = await fetch('gps-filler.php?action=startSim', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ users, route, delay,mode })
  });
  const txt = await res.text();
  log(txt);

  // >>> start de browser-gedreven loop
  startTicking(delay);
}





async function stopSim() {
  stopTicking(); // browser-interval uit
  const res = await fetch('gps-filler.php?action=stopSim');
  log(await res.text());
}




// --- TICK-LOOP: 1 stap per HTTP-call ---
let tickTimer = null;

async function doTick() {
  try {
    const r = await fetch('gps-filler.php?action=tick', { cache: 'no-store' });
    const d = await r.json();
    if (d.ok) {
      // schrijf zichtbaar in je log-venster
      log(`tick → idx=${d.idx} lat=${d.lat} lon=${d.lon} updated=${d.updated}`);
    } else {
      log(`tick: ${d.error || 'unknown error'}`);
    }
  } catch (e) {
    log('tick error: ' + e.message);
  }
}

function startTicking(delaySec) {
  stopTicking();
  const ms = Math.max(1, parseInt(delaySec, 10) || 5) * 1000;
  doTick();                      // meteen eerste stap
  tickTimer = setInterval(doTick, ms);
}

function stopTicking() {
  if (tickTimer) { clearInterval(tickTimer); tickTimer = null; }
}



    document.getElementById('startBtn').addEventListener('click', startSim);
    document.getElementById('stopBtn').addEventListener('click', stopSim);

    loadUsers();
    loadRoutes();
  </script>
  <script>
  async function pollDiagnostics() {
    try {
      const res = await fetch('gps-filler.php?action=diagnostics', { cache: 'no-store' });
      const d = await res.json();

      // Kleur op age (groen/oranje/rood)
      const ageBadge = (age) => {
        if (age === null || age === undefined) return '';
        const c = age < 10 ? '#2e7d32' : (age < 30 ? '#ef6c00' : '#c62828');
        return ` <span style="color:${c}">(${age}s)</span>`;
      };

      let html = '';
      html += `script_dir: ${d.script_dir}\n`;
      html += `cwd       : ${d.cwd}\n`;
      html += `php_sapi  : ${d.php_sapi}\n`;
      html += `now_iso   : ${d.now_iso}\n\n`;

      html += `state_path: ${d.state_path}\n`;
      html += `exists    : ${d.state_exists}\n`;
      if (d.state) {
        html += `running   : ${d.state.running}\n`;
        html += `route     : ${d.state.route}\n`;
        html += `delay     : ${d.state.delay}\n`;
        html += `users     : ${Array.isArray(d.state.users) ? d.state.users.join(', ') : ''}\n`;
        html += `last_index: ${d.state.last_index ?? '-'}\n`;
        html += `last_tick : ${d.state.last_tick_iso ?? '-'}\n`;
      }
      html += `\npoints    : route='${d.points.route ?? ''}', sim=${d.points.sim_count}, base=${d.points.base_count}\n`;

      if (d.errors && d.errors.length) {
        html += `\nerrors:\n - ${d.errors.join('\n - ')}\n`;
      }

      if (d.users && d.users.length) {
        html += `\nusers:\n`;
        d.users.forEach(u => {
          if (u.missing) {
            html += ` - ${u.device_id}: [MISSING] ${u.error || ''}\n`;
          } else {
            html += ` - ${u.device_id}: lat=${u.lat} lon=${u.lon} updated_at=${u.updated_at ?? '-'}${ageBadge(u.age_seconds)}\n`;
          }
        });
      }

      document.getElementById('diag').textContent = html;
    } catch (e) {
      document.getElementById('diag').textContent = 'diagnostics error: ' + e;
    }
  }

  // elke 1.5s updaten
  setInterval(pollDiagnostics, 1500);
  pollDiagnostics();
</script>

</body>
</html>
